name: tag-on-merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  tag:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Decide bump from PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);
            const has = (x) => labels.includes(x);

            let bump = 'patch';

            if (has('no-release')) bump = 'false';
            else if (has('major')) bump = 'major';
            else if (has('minor')) bump = 'minor';
            else if (has('patch')) bump = 'patch';

            core.setOutput('value', bump);

      - name: Bump version and push tag
        if: steps.bump.outputs.value != 'false'
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: v
          default_bump: ${{ steps.bump.outputs.value }}